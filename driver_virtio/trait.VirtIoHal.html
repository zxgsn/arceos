<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The interface which a particular hardware implementation must implement."><title>VirtIoHal in driver_virtio - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-47e7ab555ef2818a.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="driver_virtio" data-themes="" data-resource-suffix="" data-rustdoc-version="1.74.0-nightly (249595b75 2023-08-23)" data-channel="nightly" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-b2d31d2efc7e9b67.css" data-theme-dark-css="dark-3388a2fb2ef8066b.css" data-theme-ayu-css="ayu-8c3c66a6cf12cb2f.css" ><script src="../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-b2d31d2efc7e9b67.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-3388a2fb2ef8066b.css"><link rel="stylesheet" href="../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../driver_virtio/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../driver_virtio/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">VirtIoHal</a></h2><div class="sidebar-elems"><section><h3><a href="#required-methods">Required Methods</a></h3><ul class="block"><li><a href="#tymethod.dma_alloc">dma_alloc</a></li><li><a href="#tymethod.dma_dealloc">dma_dealloc</a></li><li><a href="#tymethod.mmio_phys_to_virt">mmio_phys_to_virt</a></li><li><a href="#tymethod.share">share</a></li><li><a href="#tymethod.unshare">unshare</a></li></ul><h3><a href="#implementors">Implementors</a></h3></section><h2><a href="index.html">In driver_virtio</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Trait <a href="index.html">driver_virtio</a>::<wbr><a class="trait" href="#">VirtIoHal</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>pub unsafe trait VirtIoHal {
    // Required methods
    fn <a href="#tymethod.dma_alloc" class="fn">dma_alloc</a>(
        pages: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>,
        direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>
    ) -&gt; (<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;);
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.dma_dealloc" class="fn">dma_dealloc</a>(paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, vaddr: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;, pages: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.i32.html">i32</a>;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.mmio_phys_to_virt" class="fn">mmio_phys_to_virt</a>(paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, size: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.share" class="fn">share</a>(buffer: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;[<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>]&gt;, direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>;
<span class="item-spacer"></span>    unsafe fn <a href="#tymethod.unshare" class="fn">unshare</a>(
        paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>,
        buffer: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;[<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>]&gt;,
        direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>
    );
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The interface which a particular hardware implementation must implement.</p>
<h2 id="safety"><a href="#safety">Safety</a></h2>
<p>Implementations of this trait must follow the “implementation safety” requirements documented
for each method. Callers must follow the safety requirements documented for the unsafe methods.</p>
</div></details><h2 id="required-methods" class="small-section-header">Required Methods<a href="#required-methods" class="anchor">§</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="tymethod.dma_alloc" class="method"><h4 class="code-header">fn <a href="#tymethod.dma_alloc" class="fn">dma_alloc</a>(pages: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>) -&gt; (<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;)</h4></section></summary><div class="docblock"><p>Allocates the given number of contiguous physical pages of DMA memory for VirtIO use.</p>
<p>Returns both the physical address which the device can use to access the memory, and a
pointer to the start of it which the driver can use to access it.</p>
<h5 id="implementation-safety"><a href="#implementation-safety">Implementation safety</a></h5>
<p>Implementations of this method must ensure that the <code>NonNull&lt;u8&gt;</code> returned is a
<a href="https://doc.rust-lang.org/std/ptr/index.html#safety"><em>valid</em></a> pointer, aligned to
[<code>PAGE_SIZE</code>], and won’t alias any other allocations or references in the program until it
is deallocated by <code>dma_dealloc</code>.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.dma_dealloc" class="method"><h4 class="code-header">unsafe fn <a href="#tymethod.dma_dealloc" class="fn">dma_dealloc</a>(paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, vaddr: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;, pages: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.i32.html">i32</a></h4></section></summary><div class="docblock"><p>Deallocates the given contiguous physical DMA memory pages.</p>
<h5 id="safety-1"><a href="#safety-1">Safety</a></h5>
<p>The memory must have been allocated by <code>dma_alloc</code> on the same <code>Hal</code> implementation, and not
yet deallocated. <code>pages</code> must be the same number passed to <code>dma_alloc</code> originally, and both
<code>paddr</code> and <code>vaddr</code> must be the values returned by <code>dma_alloc</code>.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.mmio_phys_to_virt" class="method"><h4 class="code-header">unsafe fn <a href="#tymethod.mmio_phys_to_virt" class="fn">mmio_phys_to_virt</a>(paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>, size: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>&gt;</h4></section></summary><div class="docblock"><p>Converts a physical address used for MMIO to a virtual address which the driver can access.</p>
<p>This is only used for MMIO addresses within BARs read from the device, for the PCI
transport. It may check that the address range up to the given size is within the region
expected for MMIO.</p>
<h5 id="implementation-safety-1"><a href="#implementation-safety-1">Implementation safety</a></h5>
<p>Implementations of this method must ensure that the <code>NonNull&lt;u8&gt;</code> returned is a
<a href="https://doc.rust-lang.org/std/ptr/index.html#safety"><em>valid</em></a> pointer, and won’t alias any
other allocations or references in the program.</p>
<h5 id="safety-2"><a href="#safety-2">Safety</a></h5>
<p>The <code>paddr</code> and <code>size</code> must describe a valid MMIO region. The implementation may validate it
in some way (and panic if it is invalid) but is not guaranteed to.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.share" class="method"><h4 class="code-header">unsafe fn <a href="#tymethod.share" class="fn">share</a>(buffer: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;[<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>]&gt;, direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a></h4></section></summary><div class="docblock"><p>Shares the given memory range with the device, and returns the physical address that the
device can use to access it.</p>
<p>This may involve mapping the buffer into an IOMMU, giving the host permission to access the
memory, or copying it to a special region where it can be accessed.</p>
<h5 id="safety-3"><a href="#safety-3">Safety</a></h5>
<p>The buffer must be a valid pointer to memory which will not be accessed by any other thread
for the duration of this method call.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.unshare" class="method"><h4 class="code-header">unsafe fn <a href="#tymethod.unshare" class="fn">unshare</a>(
    paddr: <a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.usize.html">usize</a>,
    buffer: <a class="struct" href="https://doc.rust-lang.org/nightly/core/ptr/non_null/struct.NonNull.html" title="struct core::ptr::non_null::NonNull">NonNull</a>&lt;[<a class="primitive" href="https://doc.rust-lang.org/nightly/core/primitive.u8.html">u8</a>]&gt;,
    direction: <a class="enum" href="enum.BufferDirection.html" title="enum driver_virtio::BufferDirection">BufferDirection</a>
)</h4></section></summary><div class="docblock"><p>Unshares the given memory range from the device and (if necessary) copies it back to the
original buffer.</p>
<h5 id="safety-4"><a href="#safety-4">Safety</a></h5>
<p>The buffer must be a valid pointer to memory which will not be accessed by any other thread
for the duration of this method call. The <code>paddr</code> must be the value previously returned by
the corresponding <code>share</code> call.</p>
</div></details></div><h2 id="implementors" class="small-section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../implementors/virtio_drivers/hal/trait.Hal.js" async></script></section></div></main></body></html>